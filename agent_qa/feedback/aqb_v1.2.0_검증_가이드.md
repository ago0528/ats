# AQB v1.2.0 검증 가이드

## 1) 목적
이 문서는 `aqb_v1.2.0.py` 개선사항을 빠르게 검증하기 위한 실행 가이드다.

검증 대상:
- 일관성 미달 정책 기본값: `임시 2회 평가 허용(ON)`
- 일관성 미달 정책 ON/OFF 전환 동작
- 독립 세션 호출 기본값: `ON`
- 점수 탭 이름/위치: `품질 점수 계산` (프롬프트 관리 바로 왼쪽)
- 점수 탭 데이터 소스 선택 동작
- 실행 전 적합성 진단(프리체크) 동작
- 문항 점수 → 회차 평균 → 에이전트 평균 산출
- TTFT는 PASS/FAIL만 표기되고 종합 점수에는 미반영

---

## 2) 사전 준비
1. 프로젝트 루트에서 실행
2. `.env`에 ATS/OpenAI 키 설정
3. 앱 실행

```bash
streamlit run aqb_v1.2.0.py
```

---

## 3) 기본값 검증
### 3.1 독립 세션 기본값
- 위치: 사이드바 > 실행 옵션
- 항목: `일관성용 독립 세션 호출`
- 기대 결과: 앱 최초 로드 시 **체크 ON**

### 3.2 일관성 미달 정책 기본값
- 위치: `품질 점수 계산` 탭 > 계산 옵션
- 항목: `일관성 미달 시 임시 2회 평가 허용 (ON/OFF)`
- 기대 결과: 앱 최초 로드 시 **체크 ON**

### 3.3 탭 이름/위치
- 탭 순서: `범용 테스트` → `지원자 에이전트 검증` → `이동 에이전트 검증` → `품질 점수 계산` → `프롬프트 관리`
- 기대 결과: `품질 점수 계산` 탭이 `프롬프트 관리` 바로 왼쪽

---

## 4) 기능 검증 시나리오
## 시나리오 A: 2회 응답 데이터 + 정책 ON
1. `지원자 에이전트 검증` 탭에서 `채팅 호출 횟수=2`로 실행
2. `품질 점수 계산` 탭 이동
3. 데이터 소스를 선택 (예: `지원자 에이전트 검증 결과` 또는 `범용 테스트 결과`)
4. `일관성 미달 시 임시 2회 평가 허용`을 ON 유지
5. 점수 계산 실행

기대 결과:
- `consistency_score`가 0만 나오지 않고, 2회 비교 결과에 따라 0~3 범위로 산출
- `consistency_reason`에 "임시 2회 평가" 문구 포함

## 시나리오 B: 2회 응답 데이터 + 정책 OFF
1. 시나리오 A와 동일 데이터 사용
2. `일관성 미달 시 임시 2회 평가 허용`을 OFF로 변경
3. 점수 계산 재실행

기대 결과:
- 3회 미만 문항의 `consistency_score=0`
- `consistency_reason`에 "0점 처리" 취지 문구 포함

## 시나리오 C: 독립 세션 호출 ON 검증
1. `지원자 에이전트 검증` 탭에서 `채팅 호출 횟수=3`
2. `일관성용 독립 세션 호출` ON 유지
3. ATS 호출 실행

기대 결과:
- 각 회차 응답이 독립 세션에서 수집됨
- 일관성 점수 계산 시 3회 데이터로 정상 평가 가능

## 시나리오 D: 프리체크 차단/경고 동작 검증
1. `품질 점수 계산` 탭에서 데이터 소스를 선택
2. `실행 전 적합성 진단(프리체크)` 표를 확인
3. 차단 FAIL이 있는 상태에서 실행 시도

기대 결과:
- 기본적으로 실행이 중단되고 오류 안내 표시
- 고급 모드에서 `프리체크 차단 경고 무시하고 실행` ON 시 강행 가능

---

## 5) 산출물 검증
`품질 점수 계산` 실행 후 아래를 확인:

1. 문항별 점수 테이블
- 컬럼: `semantic_score`, `consistency_score`, `accuracy_score`, `speed_score`, `stability_score`, `weighted_total`, `ttft_pass`
- 산출방식 컬럼: `semantic_calc_method`, `consistency_calc_method`, `accuracy_calc_method`, `speed_calc_method`, `stability_calc_method`

2. 회차별 평균 테이블
- `run_id` 단위 평균이 계산됨

3. 에이전트별 최종 테이블
- 회차 평균을 다시 평균한 값이 계산됨

4. 엑셀 다운로드 파일
- 시트 존재 확인:
  - 선택한 소스 시트(`applicant_results` 또는 `generic_results` 또는 `url_results`)
  - `aqb_scores_v1_2`
  - `aqb_round_summary`
  - `aqb_agent_summary`
  - `aqb_precheck`

---

## 6) 체크리스트
- [ ] 독립 세션 호출 기본값 ON
- [ ] 일관성 미달 임시 2회 정책 기본값 ON
- [ ] 품질 점수 계산 탭이 프롬프트 관리 탭 왼쪽에 위치
- [ ] 데이터 소스 선택이 가능
- [ ] 프리체크 PASS/WARN/FAIL이 표시
- [ ] 정책 ON/OFF 전환 시 `consistency_score` 결과가 달라짐
- [ ] TTFT는 `ttft_pass`로만 표시되고 가중 합산에는 반영되지 않음
- [ ] 문항별 산출방식(`*_calc_method`)이 표시
- [ ] 회차/에이전트 요약이 모두 생성됨
