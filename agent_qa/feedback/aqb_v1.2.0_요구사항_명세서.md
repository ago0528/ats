# 에이전트 품질 평가 백오피스 (AQB) v1.2.0 요구사항 명세서

## 1. 개요

### 1.1 목적

기존 `aqb_v1.1.0.py`를 버전업하여, 에이전트 품질 지표 정의 및 지표별 점수화 방식에 따른 **자동 점수 계산 기능**을 추가한다.

### 1.2 작업 범위

- 기존 코드 구조 유지, **별도 탭(시트)에 점수 계산 기능 추가**
- 6개 품질 지표에 대한 자동 스코어링 (0~5점)
- 지표별 가중 평균으로 종합 점수 산출

### 1.3 점수 산출 원칙

모든 지표는 **문항 단위 점수 → 평균** 방식으로 산출한다.

1. 각 문항(질문)별로 지표 점수(0~5)를 매긴다.
2. 전체 문항의 지표 점수를 평균하여 해당 회차의 지표 점수를 산출한다.
3. 복수 회차를 실행한 경우, 회차별 지표 점수를 다시 평균하여 최종 지표 점수를 산출한다.

이 원칙은 모든 에이전트, 모든 지표에 동일하게 적용된다.

---

## 2. 에이전트 품질 지표 정의

총 6개 지표로 구성된다. 각 지표는 0~5점 스케일로 평가한다.

### 2.1 의도 충족 (Semantic Quality)

"의도한 대로 답변하였는가?" — 사용자 의도에 맞는 조건(필터/datakey)을 사용했는가 + 응답 텍스트가 적절한가?

의도 충족은 두 가지 요소를 종합 평가한다:
- **조건 매핑 정확도:** 사용자 의도에 맞는 필터/datakey를 사용했는가
- **응답 표현 품질:** 톤앤매너 규칙을 준수하고, 사용자가 이해하기 쉬운 응답을 제공했는가

### 2.2 일관성 (Consistency)

"답변의 일관성이 있는가?" — 독립된 채팅방에서 복수 실행한 결과의 비교

- 의도된 지원서 필터당 1개 이상의 질문 준비
- 각 질문을 독립 채팅방에서 최소 3회 요청한 결과를 비교
- 일관성 판단의 핵심 정보는 숫자 및 동일한 결론 (숫자는 정확한 일치, 결론은 의미적 유사도 판단)
- 컨텍스트 오염 방지를 위해 반드시 독립된 세션에서 실행

### 2.3 정확성 (Accuracy)

"답변이 정확한가?" — 도구 사용 정확도 + 결과 수치 정확도

- 의도된 지원서 필터당 1개 이상의 질문 준비
- **도구 사용 정확도 (필터 정확도 98% 목표):** 답변 시 에이전트가 '사용한 도구'와 '사용을 기대한 도구' 비교
  - 이동/실행 에이전트: 기대한 `datakey`를 정확하게 사용했는가?
  - 지원자 관리 에이전트: 기대한 `필터 파라미터`를 정확하게 사용했는가?
  - 예외: 기대한 datakey/필터 파라미터 외 다른 도구가 호출되더라도, 정량적 결과값에 영향을 미치지 않으면 통과 판단
- **결과 정확도 (98% 목표):** 검증 API(실제 DB 조회 쿼리: Ground Truth) 결과와 정량적 수치를 프롬프트로 비교

**정확성 예외 판단 기준:**

| 예시 | 판단 | 사유 |
|------|------|------|
| "평가기간을 설정할래" 질의 시, 실행 에이전트가 "서류전형 평가기간 수정 버튼, 역량검사 전형 평가기간 수정 버튼"을 제공 | Pass | 사용자가 선택하여 원하는 결과를 얻어갈 수 있음 |
| "최근 3개월간 지원자의 남녀 성비와 수를 알려줘" 질의 시, 지원자 관리 에이전트가 "기간, 성별 + 나이" 필터를 사용 | Fail | 불필요한 필터(나이)로 인해 정량적 결과값이 달라짐 |

### 2.4 응답 속도 — 단일 도구 호출

"실행/이동/단순 필터 기준 지원자 관리 답변의 응답 속도가 빠른가?"

- 3~5개로 구성된 히스토리컬 메시지 집합을 10개 준비
- 채팅 단위로 평균 응답 대기 시간을 계산
- (초기반응성) TTFT 1초 이하 → 90% 달성 목표 — 화면에 에이전트가 생성한 답변이 최초로 노출되는 시간
- 전체 응답 평균 10초 이내 → 95% 달성 목표 (5초 이상 대기 시 이탈률 급증)
- 전문가용 요청 흐름 (에이전트 수동 선택, SA역할 OFF) → 베이스라인 측정 후 확정
- **'단일 도구 호출'을 기준으로 측정**
  - 예1) 실행 에이전트: "블라인드 옵션을 설정해줘"
  - 예2) 지원자 관리 에이전트: "최근 3개월 이내 지원자 수를 알려줘"
  - 기간 필터는 모든 지원자 관리 요청의 필수 전제 조건이므로 추가 도구 호출로 간주하지 않음

### 2.5 응답 속도 — 복수 도구 호출

"다중 필터 복합된 대규모 지원자 분석 답변의 응답 속도가 빠른가?"

- 복합 필터가 적용된 N개의 질문 준비 (성능 문제가 되는 필터 유형·조합·케이스를 집중 관리/해결하는 목적)
- (초기반응성) TTFT 1초 이하 → 90% 달성 목표
- 기준 시간은 에이전트 유형에 따라 다를 수 있음 (섹션 3.5 참조)
- 전문가용 요청 흐름 (에이전트 수동 선택, SA역할 OFF) → 베이스라인 측정 후 확정
- 호출하는 도구 개수에 따라 허용 시간이 점진적으로 증가
  - 예1) 실행 에이전트: 여러 개 기능을 동시 실행해달라고 한 경우
  - 예2) 지원자 관리 에이전트: 여러 필터를 동시에 사용해서 통계를 내달라고 한 경우

### 2.6 안정성 (Stability)

"답변이 실패 없이 안정적인가?"

- 상기 의도 파악, 정확성, 일관성, 성능 질문에 대한 성공 비율
- 각 질문 답변 생성 절차의 1단계라도 실패한 경우 (LLM 타임아웃/에러 응답, 필터 파싱 실패, DB 쿼리 오류, 연산 실패, 예외 모두 포함)

---

## 3. 지표별 점수화 방식 (0~5점)

모든 점수는 **문항 단위**로 매기며, 에이전트 점수는 문항 점수의 평균으로 산출한다.

### 3.1 의도 충족 — 조건 매핑 + 응답 표현 종합 평가

문항별로 "조건 매핑 정확도"와 "응답 표현 품질"을 종합하여 점수를 매긴다.

| 점수 | 기준 |
|------|------|
| 5 | 의도한 조건(필터/datakey)을 정확히 사용 + 응답 텍스트가 기대와 일치하고 톤앤매너 준수 |
| 4 | 의도한 조건은 맞았으나, 톤앤매너 미준수 또는 응답 표현이 부분적으로 부정확 |
| 3 | 핵심 의도는 파악했으나, 조건 일부가 누락되거나 응답이 우회적 (기대한 조건 포함 + 불필요한 조건 추가) |
| 2 | 의도를 부분적으로만 파악, 결과가 기대와 상당히 다름 |
| 1 | 의도를 잘못 파악했으나 관련 영역의 응답은 제공 (조건 완전 실패) |
| 0 | 완전히 다른 의도로 해석하거나 응답 실패 |

**산출 예시 (실행 에이전트):**

조건 매핑 정확도 70%, 톤앤매너 준수율 85%, 실패 케이스 중 부분 매핑(3점) 70% / 완전 실패(1점) 30%인 경우:

| 그룹 | 비율 | 조건 | 점수 |
|------|:---:|------|:---:|
| 조건 정확 + 톤앤매너 준수 | 60% | 70% × 85% | 5점 |
| 조건 정확 + 톤앤매너 미준수 | 10% | 70% × 15% | 4점 |
| 조건 부분 매핑 + 핵심 의도 파악 | 21% | 실패 30% × 부분 매핑 70% | 3점 |
| 조건 완전 실패 | 9% | 실패 30% × 완전 실패 30% | 1점 |

→ 문항 평균: (60×5 + 10×4 + 21×3 + 9×1) / 100 = **4.12점**

**에이전트 유형별 특성:**
- **이동 에이전트:** 조건 매핑과 의도 충족이 비례. 정확한 URL을 제공하면 의도를 정확히 충족하는 응답이 출력됨. 톤앤매너 이슈 없음.
- **실행 에이전트:** 조건 매핑과 응답 표현을 별도로 평가. 전형 겹침이 많은 기능에서 매핑 실패율이 높고, 톤앤매너를 간헐적으로 미준수.
- **지원자 관리 에이전트:** 필터 사용 정확도와 응답 텍스트 품질을 종합 평가. 단순 질의는 높은 충족도, 복합 질의는 저하.

### 3.2 일관성 — 일치 항목 비율 기반

독립 채팅방에서 최소 3회 실행한 결과를 비교한다.

| 점수 | 기준 |
|------|------|
| 5 | 3회 모두 숫자 일치 + 결론 일치 |
| 4 | 3회 모두 결론 일치, 숫자는 허용 오차 범위 내 (예: ±1%) |
| 3 | 3회 중 2회 일치 (숫자 + 결론 모두) |
| 2 | 3회 중 2회 결론만 일치, 숫자 불일치 |
| 1 | 3회 모두 결론은 유사하나 숫자가 매번 다름 |
| 0 | 3회 응답이 모두 상이 |

### 3.3 정확성 — 에이전트 유형별 평가

**이동/실행 에이전트 (datakey 기준, PASS/PARTIAL/FAIL):**

| 점수 | 기준 |
|------|------|
| 5 | 기대한 datakey 정확히 사용 |
| 3 | 기대한 datakey 포함하되 불필요한 datakey도 함께 제공 (사용자가 선택 가능) |
| 0 | 기대한 datakey 미포함 |

**지원자 관리 에이전트 (필터 정확도 + 결과 정확도):**

| 점수 | 기준 |
|------|------|
| 5 | 필터 정확 + 수치 정확 |
| 4 | 필터 정확 + 수치 허용 오차 범위 내 (예: ±1%) |
| 3 | 필터 부정확하나 수치는 정확 (우연히 맞은 경우 또는 다른 경로로 도달) |
| 2 | 필터 정확하나 수치 부정확 (필터는 이해했으나 연산/집계 오류) |
| 1 | 필터 부분 일치 + 수치 부정확 |
| 0 | 필터 완전 불일치 + 수치 부정확 |

### 3.4 응답 속도 — 단일 도구 호출 (구간 점수)

문항별 응답 시간을 측정하고, 아래 구간에 따라 점수를 매긴다.

| 점수 | 기준 |
|------|------|
| 5 | 전체 응답 5초 이내 |
| 4 | 5~8초 |
| 3 | 8~10초 (기준선) |
| 2 | 10~15초 |
| 1 | 15~20초 |
| 0 | 20초 초과 또는 타임아웃 |

### 3.5 응답 속도 — 복수 도구 호출 (에이전트 유형별 기준)

복수 도구 호출의 기준 시간은 에이전트 유형에 따라 다르게 적용한다. 지원자 관리 에이전트의 복합 질의는 Lambda 실행을 포함하므로 30초를 기준선으로 적용한다.

**지원자 관리 에이전트 복합 질의 (30초 기준선):**

| 점수 | 기준 |
|------|------|
| 5 | 20초 이내 |
| 4 | 20~30초 |
| 3 | 30~40초 (기준선) |
| 2 | 40~50초 |
| 1 | 50~60초 |
| 0 | 60초 초과 또는 타임아웃 |

**그 외 에이전트 (10초 기준선):**

| 점수 | 기준 |
|------|------|
| 5 | 10초 이내 |
| 4 | 10~15초 |
| 3 | 15~20초 (기준선) |
| 2 | 20~30초 |
| 1 | 30~45초 |
| 0 | 45초 초과 또는 타임아웃 |

TTFT는 별도 PASS/FAIL 컬럼으로만 표기하고, 종합 점수에는 반영하지 않는다 (인프라 이슈이지 에이전트 품질 이슈가 아님).

### 3.6 안정성 — 문항 단위 PASS/FAIL

문항별로 정상 응답 여부만 판정한다. 에이전트 안정성 점수는 전체 문항의 평균이 된다.

| 점수 | 기준 |
|------|------|
| 5 | 정상 응답 |
| 0 | 에러 / 타임아웃 / Null 응답 |

**산출 예시:** 177개 문항 중 173건 정상(5점) + 4건 에러(0점)
→ (173 × 5 + 4 × 0) / 177 = 4.89점

---

## 4. 종합 점수 산출

### 4.1 가중 평균 방식

종합 점수 = Σ(항목 점수 × 가중치)로 0~5점 스케일을 유지한다.

| 항목 | 가중치 | 근거 |
|------|--------|------|
| 의도 충족 | 20% | 에이전트의 핵심 역할 |
| 일관성 | 10% | 신뢰도 지표이나 정확성과 일부 중복 |
| 정확성 | 30% | 가장 직접적인 품질 지표 |
| 응답 속도 (단일 + 복수 합산) | 20% | 사용자 체감에 직접 영향 |
| 안정성 | 20% | 서비스 운영의 기본 전제 |

### 4.2 수기 확인 트리거

아래 조건 중 하나라도 해당되면 `flag_manual_review: true`로 설정한다.

- 의도 충족 점수 ≤ 2
- 정확성 점수 ≤ 2
- 안정성 점수 ≤ 2
- 종합 점수 ≤ 2.5
- 응답 중 하나라도 에러 또는 빈 응답

---

## 5. 구현 요구사항

### 5.1 기존 코드 참조

- `aqb_v1.1.0.py`의 기존 구조를 유지한다.
- 기존 데이터 입력/처리 로직은 그대로 활용한다.

### 5.2 신규 탭 추가

- 기존 탭과 별도로 **점수 계산 전용 탭(시트)**을 생성한다.
- 탭에는 다음이 포함되어야 한다:
  - 지표별 개별 점수 (0~5)
  - 가중치 적용 후 종합 점수
  - 수기 확인 필요 여부 플래그
  - 각 점수에 대한 판단 근거(사유)

### 5.3 점수 자동 계산 로직

- 각 지표의 점수화 기준(섹션 3)을 코드로 구현한다.
- LLM 평가가 필요한 지표(의도 충족, 일관성의 의미적 유사도)는 LLM 호출 로직을 포함한다.
- 규칙 기반으로 판단 가능한 지표는 규칙 기반 로직으로 구현한다:
  - 정확성 (이동/실행): datakey 일치 여부 → PASS(5) / PARTIAL(3) / FAIL(0)
  - 정확성 (지원자 관리): 필터 비교 + 수치 비교 → 0~5점
  - 응답 속도: 소요 시간 → 구간 점수
  - 안정성: 정상 응답 여부 → PASS(5) / FAIL(0)

### 5.4 제외 사항

- 응답 속도의 TTOT(Total Time of Thinking)는 현재 측정 방법이 없으므로 구현하지 않는다.
- TTFT는 별도 PASS/FAIL 컬럼으로만 표기하고, 종합 점수에는 반영하지 않는다.

---

## 6. 출력 형식

### 6.1 점수 탭 컬럼 구조 (예시)

```
query_id | query_text | agent_type | semantic_score | consistency_score | accuracy_score | speed_score | stability_score | weighted_total | flag_manual_review | semantic_reason | consistency_reason | accuracy_reason | speed_reason | stability_reason
```

### 6.2 점수 산출 예시

```json
{
  "query_id": "AM-042",
  "query_text": "최근 3개월간 지원자의 남녀 성비를 알려줘",
  "agent_type": "applicant_management",
  "scores": {
    "semantic": { "score": 5, "reason": "의도한 필터(기간, 성별)를 정확히 사용, 응답 텍스트 기대와 일치, 톤앤매너 준수" },
    "consistency": { "score": 4, "reason": "3회 모두 결론 일치, 숫자 허용 오차 내 (남 52.1% vs 52.3%)" },
    "accuracy": { "score": 5, "reason": "필터 정확(기간+성별), Ground Truth 수치 일치" },
    "speed": { "score": 4, "reason": "응답 시간 6.2초 (단일 도구 호출, 5~8초 구간)" },
    "stability": { "score": 5, "reason": "정상 응답" }
  },
  "weighted_total": 4.7,
  "flag_manual_review": false
}
```

---

_문서 버전: v1.2.0_
_작성일: 2026-02-12_
_대상 파일: aqb_v1.1.0.py → aqb_v1.2.0.py_
